+++
title = "Graduation from the 8th Cybozu Labs Youth"
date = 2019-04-18T19:26:19+09:00
draft = false
tags = ["network", "protocol"]
categories = ["engineering"]
+++

## サイボウズ・ラボユースを卒業した
少々時間が経過しましたが，3/22 に開催された第8期サイボウズ・ラボユース成果発表会
をもってラボユースを卒業したことを報告します．成果発表会の様子はこちらから見ることができます．

- [「第8期サイボウズ・ラボユース成果発表会」開催 - Cybozu Inside Out | サイボウズエンジニアのブログ](https://blog.cybozu.io/entry/2019/04/02/080000)

すでに第9期 の募集も始まっています．通年募集で早いものがちです．
非常に良い経験をさせてもらったので，当エントリが少しでも周知に貢献できればと思います．

募集のページはこちらです．

- [サイボウズ・ラボユース：募集要項](http://labs.cybozu.co.jp/youth/requirements.html)

### サイボウズ・ラボユースとは
募集要項のとおり，**個人のソフトウェア研究開発を会社が応援
(奨励金，社員の密なメンタリング)**してくれる制度で，**中卒以上の未就業者**を対象
としています．在宅による遠隔地からの参加も考慮してくれますが，基本はオンサイト勤務です．

この制度は以下のような面白い特徴があります．

- 企業の業務に直接かかわらなくて OK
- 著作権・特許権などの権利が開発者個人に帰属
- 研究成果を論文として公開して OK
- **【必須条件】成果をオープンソースで公開する**

企業の制度にもかかわらず成果物が業務に関係しないものでもよい，権利が開発者個人に
帰属する，という点が他にはない魅力だと思います．

### 応募までの経緯
私が応募に至った経緯はおおむね次のとおりです．

- M2(当時) の途中で自分の実装力への危機感  
私は基本的に研究に必要になったときに実装するタイプで，しかもこれまで PoC 実装
くらいしかやってこなかった．別に苦手ではないが，「研究 → 実装」のパターンでは
これまで通りのことしかできないのでは？博士課程ではなにか新しいことを取り入れる
必要性を感じ始める．

- [@slankdev](https://twitter.com/slankdev) 氏が Twitter で「ラボユース」とか言ってた気がした    
ラボユースってなんだ？ → 過去の成果発表ページを眺める → 出そ

#### 目的意識  

- **実装ドリブンな研究: 「実装 → 研究」の練習**  
作ったものにストーリーを与える（研究として位置づける）練習になると思いました．
積み重ねれば，実装したことそれ自体が研究として価値を持つということができるように
なります．私の目標は研究もエンジニアリングも高いレベルで両立する人間です．
研究だけでもエンジニアリングだけでも目指す像にはたどり着けません．
大変なんですけどね．

- **お金がいただける**  
お金がいただけるなら大学の研究の時間を少し削ってでもやるだろうという判断です．
大学では単発で終わらないような大きめの世界観を描いた研究をしています．M2 から研究
チームの親をやっていることもあり，大学の研究に優先的に割当てないと
研究が空中分解しかねないためです．あとは今の研究がわりと好きなので．

- **カーネルプログラミングしてみたい**  
研究の性質や背景の都合上，私はこれまでユーザ空間にプロトコルを実装してきました．
ご存知の通り Linux や FreeBSD などのプロトコルスタックはカーネル空間に実装
されています．こういうきっかけがなければ博士課程の間にわざわざ時間を確保しない
だろうなと思いました．

- **一流の職業エンジニアの方法論に倣う**  
大学の研究とは異なり，多くの企業のエンジニアは究極的に Practical であることを
重要視すると思います．つまり，**目に見える成果物の背後にはそれをその領域へと導いた
数々の実践的なノウハウ（方法論）がある**はずだと思いました．問題となるコードの場所
の当たりをつける，どこがボトルネックになっているのかすばやくざっくり計測する，
コードを書くときに意識することなど．経験が豊富な企業のエンジニアからの密な指導
というものは，私のように大学で我流でプログラムを書く人間としては喉から手が出る
ほど欲しいものです．だって研究するようになるまでほとんど授業でしかコードを書いて
こなかったんだもの（ついていくので手一杯だった）．

そんなこんなで申し込み，面接では自分の研究についていっぱい喋り，採用されました．
始めは週2で通っていましたが，自分の体調や大学の研究との兼ね合いから週1に収束
していきました．

#### exlay: 階層独立性の高いプロトコルスタックフレームワーク
成果物です．動作原理などの詳細は別記事を後日書くとして，ここでは成果発表のスライドを挙げる
にとどめます．メンターは光成さん（[@herumi](https://twitter.com/herumi)）です．
[『クラウドを支えるこれからの暗号技術』](https://herumi.github.io/ango/) や
x86 向け JIT アセンブラである [Xbyak](https://github.com/herumi/xbyak)で
ご存知の方も多いかと思います．

{{< speakerdeck "fad0dd3e2cf84c08bca27e6e222b5237" >}}

共通のインターフェイスをもったプロトコル群を用意しておき，利用者が好きな順番で
階層を積み上げるというプロトコルスタックができたら面白いな〜と思い，これを
テーマにしました．

#### 実際に何を作業したか
- カーネル空間に TCP Echo サーバをカーネルモジュールで作って自作クライアントとやり取りさせる
  - ほかの方のメンターをやっている星野さん([@starpoz](https://twitter.com/starpoz))から workqueue とか completion とかのカーネル機能を紹介してもらい実際に使ってみる
  - `__attribute__` や `aligned (alignment)` などの gcc の独自拡張を知る

- `strace` や `trace-cmd` などのトレーサを使って関数呼び出しを追いかける
  - 関数名からソースコードにおける該当箇所を探してふむふむする
  - 他にも C/C++ でコーディングするうえでの便利なツールを紹介してもらう

{{< slideshare "f6yT7qVq9R96tF" >}}

- NIC デバイスドライバの勉強をした
  - Packt から出ている [Linux Device Driver Development](https://www.packtpub.com/networking-and-servers/linux-device-drivers-development)
  という本の NIC デバドラの章を訳しながら読む．
     - Linux 4.x に対応している貴重な本です．
  - NIC デバドラを書く上で Linux カーネルレベルの抽象化をどう扱うか学ぶ
  - 特定のハードウェアのデータシートとかは読まないレベルの抽象度の話
    - 何をしたいときどの関数を呼ぶとか，そういう

- 成果発表に向けてまずはユーザ空間で動くものを作る（とのご指導をいただく）
  - ロジックができてからカーネルで動かしてみる，でないと大変
  - ということでユーザ空間実装に変更
  - この時点でこの PoC ができれば OK かな，と思うようになる

- プロトコルを共有ライブラリとして扱うように設計した
  - [Binary Hacks ――ハッカー秘伝のテクニック100選](https://www.oreilly.co.jp/books/4873112885/)
  を読んで共有ライブラリの作り方や動的なロードの仕方を勉強
  - `dlopen` とかはじめて使って楽しかった

- アプリとプロトコルスタックを別プロセスとする設計にした
  - プロトコルスタックがカーネル空間実装の場合と同様のモデルになる
  - アプリが使用する exlay API （send, recv, close など）は RPC で実装した
    - glibc で完結できるので SunRPC + XDR を採用，だいぶ詳しくなった

- UDP/IP/Ethernet のスタックを実装
  - Ethernet しか間に合わなかった
  - スタックのフレームワーク本体がけっこう大変だったのもある
     - とはいえ実装力が足りてないな〜〜〜
- 成果発表
  - 直前で不具合を発見して修正したが make し忘れてうまく動かなかった（悲しい）
  - 懇親会で光成さんに「もちょっと実装頑張りましょうね」と言われる

#### 今後の展望
- ユーザ空間上でのプロトコルの充実  
今の所 UDP/IP/Ethernet しか無い（しかも機能が網羅的ではない）ので簡単な TCP くらい
は用意したい．

- トンネリングエンドポイントのエクスポート  
例えば VXLAN (L2 over UDP) なんかを exlay で実現しようと思ったら，
Ethernet, IP, UDP, VXLAN, Ethernet みたいに **アンダーレイからスタックを記述
しなければならない** のでもはやトンネリングではない状態です．なので，
作成したスタックをトンネルエンドポイントとしてエクスポートし，exlay API で
触れるようにしてトンネリングプロトコルが簡単に実装できるようにする．

- カーネル空間実装  
FreeBSD のカーネルにカーネルモジュールとして実装することを考えています．
可能なら TCP(UDP)/IP といったルーチンを使いまわして exlay に組み込めたらかっこいい
なと思います．この場合，各プロトコルはカーネルモジュールとして提供します．

#### 感想および反省
エンジニアリングの現場で活躍している光成さんや星野さんとした実践的なお話は，
大学にいるだけではなかなかできないことだと思いました．もちろん一般的な企業の
インターンでもこういうお話はできると思いますが，**自分がやりたいことに対して**
時間（とお金）を費やしてもらえる機会は他では得難いものだと思います．

ただ，光成さんや星野さんといった人的リソースを活用しきれたかと言われれば，
まだまだだなと感じます．exlay は学位取得には直接関係しない（と現状は思われる）
私の趣味研究です．学位取得に関係するテーマでラボユースに申し込むと
ものすごい加速するんじゃないでしょうか．exlay についても論文は書くつもりでいます．
どの段階で書くかはわからんが...

あまり時間を割かなかった私でさえ濃い経験ができたので，いわんやをや．
実装ドリブンな研究として繋がりそうだし．友達もできたし．本当にやってみてよかった！

### 応募を検討しているひとへ
- もっと詳しく知りたいひとへ  
気になることがあれば Twitter の DM でもリプでもお答えします．というか，
私に限らずほとんどの卒業生は相談に乗ってくれると思います．これをきっかけに
お友達になりましょう．ぜひ．

- 具体的に作りたいものがないひとへ  
ツイートの通り，「XX ができるようになりたい」というふうに伝えるでも私は良いと
思っています．XX ができるようになっていくうちに XX を使ったなにかが作れそう
だとひらめくと思います．ぜひ．
{{< tweet 1117645489023774720 >}}

- 実装力が足りてないと思っているひとへ  
落ちたときに考えましょう．それに，ある程度のところまで引き上げてもらったら
そのあとは自力でなんとかできるようになると思います．そこに到達するまでに
個人差があるだけです．
ラボユースで実装力を高めるすばらしいきっかけだとと思って．ぜひ．

- B4 および M1, M2 のひとへ  
卒論や修論のテーマと関係しそうなことを選ぶと研究が加速します．ぜひ．

- D のひとへ  
私以外にそんなことをする人がいるとはなかなか思えませんが，なるべく学位取得に
関係するテーマを選ぶと良いでしょう．学振に採用されている方は，ラボユースと
併用できるかはわかりませんが．ぜひ．


### ネット上で影響力が強いひとへ
特にこのエントリの共有でなくてもいいのでラボユースという制度を周知していただければ
幸いです．私にもっと（ネット上の）チカラがあれば...
